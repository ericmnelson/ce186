<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>

<div class="row wrapper border-bottom white-bg page-heading2">
    <div class="col-lg-10">
        <h2 class="m-l-md"><%= current_house.name if current_house%> Dashboard</h2>
        <!-- <p class="gradient-blue-header page-title-p"><%= current_house.name if current_house%> Dashboard</p> -->
    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
  <div class="row" >
    <div class="col-lg-8" >
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Showers</h5>
                <div class="pull-right">
                    <div class="btn-group">
                        <button type="button" class="btn btn-xs btn-white">Last Week</button>
                    </div>
                </div>
            </div>
            <div class="ibox-content">
                <div class="flot-chart" style="min-height:400px;">
                    <div class="flot-chart-content" id="house-shower-by-user-chart"></div>
                </div>
             </div>
          </div>
      </div>
      <div class="col-lg-4">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Weekly Progress</h5>
            </div>
            <div class="ibox-content">
              <ul class="stat-list">
                  <li>
                      <h2 id="num_showers" class="no-margins"></h2>
                      <small>Number of showers in period</small>
                      <div id="num_showers_change" class="stat-percent"> </div>
                      <div class="progress progress-mini">
                          <div id="num_showers_change_bar" style="width: 48%;" class="progress-bar"></div>
                      </div>
                  </li>
                  <li>
                      <h2 id="total_duration"class="no-margins "></h2>
                      <small>Total duration of showers in period</small>
                      <div id="total_duration_change" class="stat-percent"> </div>
                      <div class="progress progress-mini">
                          <div id="total_duration_change_bar" style="width: 48%;" class="progress-bar"></div>
                      </div>
                  </li>
                </ul>
              </div>
          </div>
      </div>
  </div>


<div class="row">
    <div class="col-lg-4">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Pie Chart</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="close-link">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">
                <canvas id="user-pie-chart">
                </canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="row">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>House Leaderboard</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <table class="table table-hover no-margins">
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Value</th>
                        </tr>
                        </thead>
                        <tbody>
                        <% @users.each do |user| %>
                           <tr>
                             <td><%= user.full_name %></td>
                             <td><i class="fa fa-clock-o"></i> 11:20pm</td>
                             <td><%= rand(100) %></td>
                             <td class="text-navy"> <i class="fa fa-level-up"></i> 24% </td>
                           </tr>
                        <% end %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>


<script>
var theme_colors = ["#42FFCB", "#78E3FD", "#23C59E", "#48BEFF", "#48FEFF", "#3DFAFF", "#48A59E",  "#0FCF9E"]

Highcharts.theme = {
    colors: theme_colors,
    title: {
        style: {
            color: '#000',
            font: 'bold 16px "Trebuchet MS", Verdana, sans-serif'
        }
    },
    subtitle: {
        style: {
            color: '#666666',
            font: 'bold 12px "Trebuchet MS", Verdana, sans-serif'
        }
    },

    legend: {
        itemStyle: {
            font: '9pt Trebuchet MS, Verdana, sans-serif',
            color: 'black'
        },
        itemHoverStyle:{
            color: 'gray'
        }
    }
};

Highcharts.setOptions(Highcharts.theme);

$(document).ready(function() {
    var level_up = '<i class="fa fa-level-up text-navy"></i>'
    var level_down = '<i class="fa fa-level-down text-navy"></i>'

    var format_change = function(str){
      str += "% ";
      if (str.startsWith("-")){
        str += level_down;
      } else {
        str += level_up;
      }
      return str
    }

    $.getJSON("/houses/38/showers/pie_chart_data.json", function(data){
      make_pie_chart(data)
    });

    $.getJSON("/houses/38/showers/last_week.json", function(data){
      total_duration_change = format_change(data['total_duration_change'])
      $("#total_duration_change_bar").css("width", data['total_duration_change']+"%")

      num_showers_change = format_change(data['num_showers_change'])
      $("#num_showers_change_bar").css("width", data['num_showers_change']+"%")

      $("#total_duration").text(data['total_duration'] + " minutes");
      $("#total_duration_change").html(total_duration_change);
      $("#num_showers").text(data['num_showers']);
      $("#num_showers_change").html(num_showers_change);
    })

    var data2 = [
        [gd(2012, 1, 1), 7], [gd(2012, 1, 2), 6], [gd(2012, 1, 3), 4], [gd(2012, 1, 4), 8],
        [gd(2012, 1, 5), 9], [gd(2012, 1, 6), 7], [gd(2012, 1, 7), 5], [gd(2012, 1, 8), 4],
        [gd(2012, 1, 9), 7], [gd(2012, 1, 10), 8], [gd(2012, 1, 11), 9], [gd(2012, 1, 12), 6],
        [gd(2012, 1, 13), 4], [gd(2012, 1, 14), 5], [gd(2012, 1, 15), 11], [gd(2012, 1, 16), 8],
        [gd(2012, 1, 17), 8], [gd(2012, 1, 18), 11], [gd(2012, 1, 19), 11], [gd(2012, 1, 20), 6],
        [gd(2012, 1, 21), 6], [gd(2012, 1, 22), 8], [gd(2012, 1, 23), 11], [gd(2012, 1, 24), 13],
        [gd(2012, 1, 25), 7], [gd(2012, 1, 26), 9], [gd(2012, 1, 27), 9], [gd(2012, 1, 28), 8],
        [gd(2012, 1, 29), 5], [gd(2012, 1, 30), 8], [gd(2012, 1, 31), 25]
    ];

    var data3 = [
        [gd(2012, 1, 1), 800], [gd(2012, 1, 2), 500], [gd(2012, 1, 3), 600], [gd(2012, 1, 4), 700],
        [gd(2012, 1, 5), 500], [gd(2012, 1, 6), 456], [gd(2012, 1, 7), 800], [gd(2012, 1, 8), 589],
        [gd(2012, 1, 9), 467], [gd(2012, 1, 10), 876], [gd(2012, 1, 11), 689], [gd(2012, 1, 12), 700],
        [gd(2012, 1, 13), 500], [gd(2012, 1, 14), 600], [gd(2012, 1, 15), 700], [gd(2012, 1, 16), 786],
        [gd(2012, 1, 17), 345], [gd(2012, 1, 18), 888], [gd(2012, 1, 19), 888], [gd(2012, 1, 20), 888],
        [gd(2012, 1, 21), 987], [gd(2012, 1, 22), 444], [gd(2012, 1, 23), 999], [gd(2012, 1, 24), 567],
        [gd(2012, 1, 25), 786], [gd(2012, 1, 26), 666], [gd(2012, 1, 27), 888], [gd(2012, 1, 28), 900],
        [gd(2012, 1, 29), 178], [gd(2012, 1, 30), 555], [gd(2012, 1, 31), 993]
    ];

    var doughnutOptions = {
        legend: {
            display: true,
            position: "bottom"
        },
        title: {
            display: true,
            text: 'Shower Duration per User in last week'
        },
        cutoutPercentage: 35,
        segmentShowStroke: true,
        segmentStrokeColor: "#fff",
        segmentStrokeWidth: 2,
        percentageInnerCutout: 45, // This is 0 for Pie charts
        animationSteps: 100,
        animationEasing: "easeOutBounce",
        animateRotate: true,
        animateScale: false,
        responsive: true,
    };

    var make_pie_chart = function(data){
      var ctx = $("#user-pie-chart");
      data["datasets"][0]["backgroundColor"] = theme_colors
      data["datasets"][0]["hoverBackgroundColor"] = theme_colors
      var myPieChart = new Chart(ctx,{
          type: 'doughnut',
          data: data,
          options: doughnutOptions
      });
    }

    var dataset = [
        {
            label: "Number of orders",
            data: data3,
            color: "#1ab394",
            bars: {
                show: true,
                align: "center",
                barWidth: 24 * 60 * 60 * 600,
                lineWidth:0
            }

        }, {
            label: "Payments",
            data: data2,
            yaxis: 2,
            color: "#1C84C6",
            lines: {
                lineWidth:1,
                    show: true,
                    fill: true,
                fillColor: {
                    colors: [{
                        opacity: 0.2
                    }, {
                        opacity: 0.4
                    }]
                }
            },
            splines: {
                show: false,
                tension: 0.6,
                lineWidth: 1,
                fill: 0.1
            },
        }
    ];
    var options = {
        xaxis: {
            mode: "time",
            tickSize: [3, "day"],
            tickLength: 0,
            axisLabel: "Date",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: 'Arial',
            axisLabelPadding: 10,
            color: "#d5d5d5"
        },
        yaxes: [{
            position: "left",
            max: 1070,
            color: "#d5d5d5",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: 'Arial',
            axisLabelPadding: 3
        }, {
            position: "right",
            clolor: "#d5d5d5",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: ' Arial',
            axisLabelPadding: 67
        }
        ],
        legend: {
            noColumns: 1,
            labelBoxBorderColor: "#000000",
            position: "nw"
        },
        grid: {
            hoverable: false,
            borderWidth: 0
        }
    };
    function gd(year, month, day) {
        return new Date(year, month - 1, day).getTime();
    }
    var previousPoint = null, previousLabel = null;
    // $.plot($("#flot-dashboard-chart"), dataset, options);

    var create_chart = function(data){
      Highcharts.chart('house-shower-by-user-chart', {
        chart: {
            type: 'column'
        },
        title: {
            text: 'House Shower Usage'
        },
        xAxis: {
            categories: data['categories']
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Duration of showers in minutes'
            },
            stackLabels: {
                enabled: false,
                style: {
                    fontWeight: 'bold',
                    color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                }
            }
        },
        legend: {
            align: 'right',
            x: -30,
            verticalAlign: 'top',
            y: 25,
            floating: true,
            backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
            borderColor: '#CCC',
            borderWidth: 1,
            shadow: false
        },
        tooltip: {
            headerFormat: '<b>{point.x}</b><br/>',
            pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
        },
        plotOptions: {
            column: {
                stacking: 'normal',
                dataLabels: {
                    enabled: false,
                    color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
                }
            }
        },
        series: data['series']
      });
    }

    $.getJSON("/api/showers_by_user.json?past_days=7", function(data){
      console.log(data);
      create_chart(data);
    })
});
</script>
